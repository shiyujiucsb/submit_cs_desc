# Submit.cs working procedures
This document describes the steps to process a submission on submit.cs.
Please see [the code on github](https://github.com/ucsb-cs/submit/blob/master/submit/workers/worker.py) for details.

## Overview
The front-end puts all the files (build files, execution files, source files that are submitted by the student) into different paths:
```
worker   # initial working directory
+--  src
|    ... # source code
|    ... # extra build files
+--  inputs
|    ... # inputs given by test cases (often stdin)
+--  results
|    ... # files recording the outputs
+--  execution_files
|    ... # executable binary and scripts
Makefile
```
The front-end sends a JSON file ``data.json`` to the back-end, in which three fields are given:
* ``executable``: the name of the executable binary submitted by the student that is supposed to be run. This field is rarely useful.
* ``make_target``: make target, which entry in the Makefile to use.
* ``test_cases``: containing all the test cases.

At the end of front-end, ``src``, ``inputs``, ``execution_files`` and ``Makefile`` are available. 
See Notes below for how the files are generated by the front-end.
The folder ``results`` is created by the back-end (submit worker). 

The back-end first builds the project:
```
make -f ../Makefile -C src make_target
```
After ``make``, the generated binary files are in the folder ``src``. The worker needs to merge them with the files in ``execution_files`` firstly. This is done by the worker **for each test case** as follows:
1. Create a temporary folder ``tmp_dir``.
2. Copy *every* file in ``execution_files`` into ``tmp_dir``.
3. *Selectively* copy files in ``src`` into ``tmp_dir`` (see Notes below for the details).
4. Run the program with ``tmp_dir`` as the working directory, and keep the outputs in the Python dictionary ``results``.
5. Remove ``tmp_dir`` entirely.

After all the test cases are finished, the worker dumps the dictionary ``results`` into a file and puts it in the folder ``results``. Then typically ``diff`` is run to compare the output results with the expected. Finally the comparison results are sent back to the front-end. 

## Notes
### Front-end operations
The files on the back-end are generated as follows:
1. The files under **Select Build Files** are put in ``src`` (*to be confirmed*).
2. The files under **Select Execution Files** are put in ``execution_files``.
3. The files under **Select Expected Files** must appear in ``src``, and each of them can be copied to ``execution_files`` by selecting the box *Copy to Execution Environment*.

### Worker details
When selectively copying the souce files in ``src`` to ``tmp_dir``, the worker first checks if the program to run (assuming to be the first argument of the command) is one of the follows:
* bash/sh
* head/tail
* python/python2/python3
* spim
* valgrind

Then:
* If so, the worker only copies the scripts that appear in the command to run. For example, if the command is ``python3 main.py``, then worker only copies ``main.py`` from ``src`` to ``tmp_dir``.
* If not, the worker only tries to find the binary file in ``src`` (given by the first argument in the command) to run. For example, a C++ program generates a binary ``a.out``. If the command is ``./a.out``, the worker only sets the path of ``a.out`` as the path of the executable file. Note that in this case *no file is copied*. The executable binary will be run later with ``tmp_dir`` as the working directory.

### stdin, stdout and stderr
These concepts are the same as in [Linux](https://en.wikipedia.org/wiki/Standard_streams).
To prepare test cases for the program (e.g., ``a.out``):
```
./a.out < stdin.txt > stdout.txt 2> stderr.txt
```
``stdin.txt`` contains the user inputs that you have prepared.
``stdout.txt`` contains the output of the program.
``stderr.txt`` contains the error message of the program.

